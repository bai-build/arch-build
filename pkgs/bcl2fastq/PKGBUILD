# Maintainer: Fabio Zanini <fabio _DOT zanini AT_ fastmail DOT_ fm>
pkgname=bcl2fastq
pkgver=2.19.0
pkgrel=1
pkgdesc='Demultiplexes data and converts BCL files generated by Illumina sequencers to FASTQ for downstream analysis.'
arch=('i686' 'x86_64')
url="https://support.illumina.com/sequencing/sequencing_software/bcl2fastq-conversion-software.html"
license=('custom')
#depends=('python-matplotlib')
makedeps=('gcc>=4.9')
source=("https://support.illumina.com/content/dam/illumina-support/documents/downloads/software/bcl2fastq/bcl2fastq2-v${pkgver}.tar.gz" "http://sourceforge.net/projects/boost/files/boost/1.55.0/boost_1_55_0.tar.gz")
md5sums=('1778aa271d7af8cbf9d1065994603a30' '93780777cfbf999a600f62883bd54b17')
options=('!emptydirs')

build() {
  # get boost 1.55, correct its python invocation, and fake it as 1.54 for bcl2fastq
  msg "Fix python2 in boost bootstrap"
  sed -i 's/PYTHON=python/PYTHON=python2.7/' "${srcdir}/boost_1_55_0/bootstrap.sh"

  msg "Fake boost 1.54 with boost 1.55"
  cd "${srcdir}"
  rm -rf boost_1_54_0
  mv boost_1_55_0 boost_1_54_0
  tar -cf boost_1_54_0.tar boost_1_54_0 && bzip2 boost_1_54_0.tar
  rm bcl2fastq/redist/boost_1_54_0.tar.bz2
  cp boost_1_54_0.tar.bz2 bcl2fastq/redist/

  msg "Make build folder"
  cd "${srcdir}"
  rm -rf "${srcdir}/build"
  mkdir -p "${srcdir}/build"
  cd build

  msg "Configure bcl2fastq"
  "${srcdir}/${pkgname}/src/configure" --prefix="${pkgdir}"

  msg "Make bcl2fastq"
  make -j2
}

package() {
  cd "${srcdir}/build"
  make install

  # illumina uses folders
  install -d "${pkgdir}"/usr/bin
  mv "${pkgdir}"/bin/bcl2fastq "${pkgdir}"/usr/bin/bcl2fastq
  rm -rf "${pkgdir}"/bin

  mv "${pkgdir}"/share "${pkgdir}"/usr/share


}
