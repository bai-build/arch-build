pkgname=zerotier-one-debug-git
_pkgname=zerotier-one
pkgver=${PKGVER:-autogenerated}
pkgrel=${PKGREL:-1}
provides=('zerotier-one')
conflicts=('zerotier-one')
pkgdesc="Creates virtual Ethernet networks of almost unlimited size."
arch=('i686' 'x86_64' 'armv7h')
url="https://www.zerotier.com/index.html"
license=('GPL3')
groups=()
depends=("gcc-libs" "http-parser")
makedepends=("ruby-ronn")
source=("zerotier-one::git://github.com/zerotier/ZeroTierOne")
md5sums=('SKIP')

pkgver() {
    if [[ "$PKGVER" ]]; then
        echo "$PKGVER"
        return
    fi

    cd "$srcdir/$_pkgname/"
    local date=$(git log -1 --format="%cd" --date=short | sed s/-//g)
    local count=$(git rev-list --count HEAD)
    local commit=$(git rev-parse --short HEAD)
    local z_version="$(cat zerotier-one.spec | awk '/Version:/ { print $2 }')"

    echo "${z_version}_${date}.${count}.${commit}"
}

check() {
    cd "$srcdir/$_pkgname"
    make selftest
    ./zerotier-selftest
}

build() {
    cd "$srcdir/$_pkgname/"
    echo "Building with debug enabled"
    make debug
}

package() {
    cd "$srcdir/$_pkgname"
    mkdir -p $pkgdir/var/lib/zerotier-one $pkgdir/usr/bin $pkgdir/usr/lib/systemd/system
    install zerotier-one $pkgdir/var/lib/zerotier-one
    install debian/zerotier-one.service $pkgdir/usr/lib/systemd/system
    chmod -x $pkgdir/usr/lib/systemd/system/zerotier-one.service
    cd $pkgdir/usr/bin
    ln -s /var/lib/zerotier-one/zerotier-one zerotier-cli
    ln -s /var/lib/zerotier-one/zerotier-one zerotier-idtool
    ln -s /var/lib/zerotier-one/zerotier-one zerotier-one
}
